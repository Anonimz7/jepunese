<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belajar Kanji JLPT</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #fbbf24;
            --bg: #f8fafc;
            --text: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --overlay-bg: rgba(0, 0, 0, 0.6);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --secondary: #f59e0b;
            --bg: #1e293b;
            --text: #f8fafc;
            --card-bg: #334155;
            --border: #475569;
            --overlay-bg: rgba(0, 0, 0, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background 0.3s, color 0.1s;
        }

        body {
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* Controls */
        .controls {
            max-width: 1000px;
            margin: 0 auto 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .level-selector {
            display: flex;
            gap: 5px;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .level-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            background: transparent;
            color: var(--text);
            transition: background 0.2s ease, color 0.2s ease;
        }

        .level-btn:hover {
            background: var(--border);
        }

        .level-btn.active {
            background: var(--primary);
            color: white;
        }

        #searchInput {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            background: var(--card-bg);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, button {
            padding: 10px 15px;
            background: var(--card-bg);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Kanji Grid */
        .kanji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Slightly smaller cards */
            gap: 15px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .kanji-card {
            background: var(--card-bg);
            border-radius: 12px; /* Ukuran sudut agak membulat */
            padding: 20px 15px; /* Padding atas/bawah lebih besar, kiri/kanan standar */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); /* Shadow yang lebih halus */
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; /* Transisi lebih banyak properti */
            cursor: pointer;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1.2; /* Proporsi kartu sedikit lebih tinggi */
            user-select: none; /* Agar teks tidak terseleksi saat klik cepat */
        }

        .kanji-card:hover {
            transform: translateY(-7px); /* Naik sedikit lebih tinggi */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15); /* Shadow lebih jelas saat dihover */
            border-color: var(--primary); /* Border berubah warna saat dihover */
        }

        .kanji-card .kanji {
            font-size: 2.5rem; /* Ukuran kanji tetap besar */
            font-weight: 600; /* Kanji sedikit lebih tebal */
            margin-bottom: 8px; /* Jarak bawah kanji */
            color: var(--text); /* Warna kanji mengikuti tema */
            line-height: 1; /* Pastikan tinggi baris tidak menambah ruang ekstra */
            text-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Shadow tipis pada teks kanji */
        }

        .kanji-card .romaji-basic {
            font-size: 0.9rem; /* Romaji sedikit lebih besar dari sebelumnya */
            color: #64748b; /* Warna abu-abu netral */
            font-style: italic;
            font-weight: 400; /* Normal weight */
        }

        /* Gaya card pada dark mode */
        [data-theme="dark"] .kanji-card {
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        [data-theme="dark"] .kanji-card:hover {
             box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
             border-color: var(--primary);
        }
        [data-theme="dark"] .kanji-card .kanji {
             text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* Shadow lebih jelas di dark mode */
        }


        /* Status & Message */
        .status {
            text-align: center;
            margin: 20px 0;
            color: var(--primary);
        }

        .message {
            text-align: center;
            grid-column: 1 / -1;
            padding: 20px;
            color: var(--text);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background 0.3s, border-color 0.3s;
        }

        .theme-toggle i {
            font-size: 1.2rem;
            color: var(--text);
            transition: color 0.3s;
        }

        /* Modal & Flashcard Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .flashcard {
            background: var(--card-bg);
            color: var(--text);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px; /* Max width for the flashcard */
            width: 90%;
            max-height: 90vh; /* Max height to prevent overflow */
            overflow-y: auto; /* Enable scrolling if content is too long */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: rotateY(180deg) scale(0.8); /* Initial state for animation */
            opacity: 0;
            transition: transform 0.6s ease-out, opacity 0.6s ease-out;
            perspective: 1000px; /* Perspective for 3D effect */
        }

        .modal-overlay.visible .flashcard {
            transform: rotateY(0deg) scale(1); /* Final state */
            opacity: 1;
        }

        .flashcard-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 10; /* Ensure close button is above content */
        }

        .flashcard-close:hover {
            color: var(--primary);
        }

        .flashcard h2 {
            text-align: center;
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 700;
        }

        .flashcard .romaji-basic-modal {
            text-align: center;
            font-size: 1.1rem;
            font-style: italic;
            color: #64748b; /* Neutral grey */
            margin-bottom: 20px;
        }


        .flashcard h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .flashcard h4 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .flashcard ul, .flashcard dl {
            list-style: none;
            padding-left: 0;
            margin-bottom: 15px;
        }

        .flashcard li, .flashcard dt, .flashcard dd {
            margin-bottom: 8px;
        }

        .flashcard dt {
             font-weight: 500;
             color: var(--text);
             margin-right: 5px;
        }

        .flashcard dd {
            margin-left: 0; /* Remove default dd margin */
        }

        .flashcard p {
             margin-bottom: 10px;
             color: #64748b; /* Grey text for info messages */
             font-style: italic;
        }


        .flashcard .reading-item,
        .flashcard .meaning-item,
        .flashcard .example-item {
            background: var(--bg); /* Subtle background for items */
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .flashcard .reading-item span,
        .flashcard .meaning-item span,
        .flashcard .example-item span {
            display: block; /* Ensure each part is on new line */
        }

        .flashcard .reading {
            font-weight: 600;
            color: var(--primary);
        }

         .flashcard .reading .romaji {
            font-style: italic;
            color: #64748b;
            font-weight: 400;
            font-size: 0.9em;
        }

        .flashcard .reading .example-word {
            font-size: 0.9em;
            color: var(--text);
            margin-left: 10px;
        }
         .flashcard .reading .example-word .romaji {
             font-size: 1em; /* Reset font-size within example */
         }

        .flashcard .meaning-form {
            font-weight: 600;
            color: var(--primary);
        }
        .flashcard .meaning-form .romaji {
             font-style: italic;
            color: #64748b;
            font-weight: 400;
            font-size: 0.9em;
        }

        .flashcard .meaning-text {
            color: var(--secondary);
            font-weight: 500;
        }

        .flashcard .example-japanese {
            font-weight: 600;
             color: var(--primary);
        }
         .flashcard .example-japanese ruby rt {
             font-size: 0.7em; /* Smaller furigana */
             font-weight: 400;
         }

        .flashcard .example-romaji {
            font-style: italic;
            color: #64748b;
             font-size: 0.9em;
        }

        .flashcard .example-meaning {
            color: var(--secondary);
            font-weight: 500;
            font-size: 0.9em;
        }


        .flashcard .metadata span {
            display: inline-block; /* Display metadata items inline */
            margin-right: 15px;
            font-size: 0.9em;
            color: #64748b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch; /* Stretch items */
            }

            .level-selector {
                justify-content: center; /* Center level buttons */
            }

            #searchInput {
                width: 100%;
            }

            .pagination-controls {
                width: 100%; /* Full width controls */
                justify-content: space-between; /* Space out items */
            }

            .kanji-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Smaller cards on mobile */
                gap: 10px;
            }

            .kanji-card {
                 padding: 15px 10px; /* Reduced padding */
            }

             .kanji-card .kanji {
                font-size: 2rem;
             }

             .kanji-card .romaji-basic {
                 font-size: 0.8rem;
             }

             .flashcard {
                 padding: 20px; /* Reduced modal padding */
             }

             .flashcard h2 {
                 font-size: 3rem;
             }
        }
         @media (max-width: 480px) {
             .kanji-grid {
                 grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* Even smaller cards */
                 gap: 8px; /* Gap lebih kecil */
             }

             .kanji-card {
                  padding: 12px 6px; /* Padding lebih kecil lagi */
                  border-radius: 10px;
             }
              .kanji-card .kanji {
                 font-size: 1.8rem;
                  margin-bottom: 3px;
              }
              .kanji-card .romaji-basic {
                  font-size: 0.7rem;
              }
         }
    </style>
</head>
<body>
    <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </div>

    <header>
        <h1>Belajar Kanji JLPT</h1>
        <div class="level-selector" id="levelSelector">
            <button class="level-btn active" data-level="n5">N5</button>
            <button class="level-btn" data-level="n4">N4</button>
            <button class="level-btn" data-level="n3">N3</button>
            <button class="level-btn" data-level="n2">N2</button>
            <button class="level-btn" data-level="n1">N1</button>
        </div>
    </header>

    <div class="controls">
        <input
            type="text"
            id="searchInput"
            placeholder="Cari kanji (contoh: 見, mi, melihat...)"
            autocomplete="off"
        >

        <div class="pagination-controls">
            <select id="perPage">
                <option value="10">10 per halaman</option>
                <option value="20">20 per halaman</option>
                <option value="50">50 per halaman</option>
                <option value="100">100 per halaman</option>
                <option value="0">Tampilkan Semua</option>
            </select>

            <button id="prevBtn"><i class="fas fa-chevron-left"></i></button>
            <span id="pageInfo">Halaman 1</span>
            <button id="nextBtn"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div class="status" id="statusInfo">Memuat data N5...</div>

    <div class="kanji-grid" id="kanjiContainer">
        <div class="message">Memuat data kanji...</div>
    </div>

    <div class="modal-overlay" id="flashcardModalOverlay">
        <div class="flashcard" id="flashcardContent">
            <button class="flashcard-close" id="flashcardCloseBtn">&times;</button>
            </div>
    </div>


    <script>
        // Config
        let currentLevel = 'n5';
        let kanjiData = [];
        let filteredData = [];
        let currentPage = 1;
        let perPage = 50; // Default to 50 per page
        let activeKanjiData = null; // To store data for the currently open flashcard

        // DOM Elements
        const levelButtons = document.querySelectorAll('.level-btn');
        const searchInput = document.getElementById('searchInput');
        const perPageSelect = document.getElementById('perPage');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        const statusInfo = document.getElementById('statusInfo');
        const kanjiContainer = document.getElementById('kanjiContainer');

        // Modal Elements
        const flashcardModalOverlay = document.getElementById('flashcardModalOverlay');
        const flashcardContent = document.getElementById('flashcardContent');
        const flashcardCloseBtn = document.getElementById('flashcardCloseBtn');


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial perPage value on the select element
            perPageSelect.value = perPage;
            loadLevelData(currentLevel);
            setupEventListeners();
            loadTheme();
        });

        // Load JSON Data for Selected Level
        async function loadLevelData(level) {
            try {
                statusInfo.textContent = `Memuat data ${level.toUpperCase()}...`;
                kanjiContainer.innerHTML = '<div class="message">Memuat data kanji...</div>';

                // Use a unique timestamp or version query parameter to bust cache during development
                // In production, rely on server-side caching headers or file versioning
                const response = await fetch(`data/${level}.json?v=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`File data/${level}.json tidak ditemukan atau ada masalah jaringan. Status: ${response.status}`);

                kanjiData = await response.json();
                filteredData = [...kanjiData];

                currentPage = 1; // Reset page when loading new data
                renderKanji();
                updateStatus();

                // Update active level button
                levelButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.level === level);
                });

            } catch (error) {
                kanjiContainer.innerHTML = `
                    <div class="message error">
                        Gagal memuat data ${level.toUpperCase()}.
                        <br>Pastikan file <strong>data/${level}.json</strong> ada dan formatnya benar.
                        <br>Detail error: ${error.message}
                    </div>
                `;
                console.error("Error loading kanji data:", error);
                statusInfo.textContent = ''; // Clear status on error
                 updateStatus(); // Update pagination state to show no data
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Level selector
            levelButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.level !== currentLevel) {
                         currentLevel = btn.dataset.level;
                         searchInput.value = ''; // Clear search on level change
                         // Instead of calling handleSearch, directly load level data
                         loadLevelData(currentLevel);
                         // loadLevelData will reset filteredData and currentPage
                    }
                });
            });

            // Search with debounce
            searchInput.addEventListener('input', debounce(handleSearch, 300));

            // Pagination controls
            perPageSelect.addEventListener('change', () => {
                perPage = parseInt(perPageSelect.value);
                currentPage = 1;
                renderKanji();
                updateStatus();
            });

            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderKanji();
                    updateStatus();
                    scrollToTop(); // Optional: scroll to top on page change
                }
            });

            nextBtn.addEventListener('click', () => {
                 const totalPages = perPage === 0 ? 1 : Math.ceil(filteredData.length / perPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderKanji();
                    updateStatus();
                     scrollToTop(); // Optional: scroll to top on page change
                }
            });

            // Theme toggle
            document.getElementById("themeToggle").addEventListener('click', toggleTheme);

            // Modal close listeners
            flashcardCloseBtn.addEventListener('click', closeFlashcard);
            flashcardModalOverlay.addEventListener('click', (e) => {
                // Close modal if clicking outside the flashcard content
                // Check if the click target is the overlay itself, not a child element within the flashcard
                if (e.target === flashcardModalOverlay) {
                    closeFlashcard();
                }
            });

             // Close modal with ESC key
            document.addEventListener('keydown', (e) => {
                // Check if modal is currently visible before closing
                if (e.key === 'Escape' && flashcardModalOverlay.classList.contains('visible')) {
                    closeFlashcard();
                }
            });
        }

        // Search Function
        function handleSearch() {
            const keyword = searchInput.value.toLowerCase().trim();

            if (!keyword) {
                filteredData = [...kanjiData];
            } else {
                filteredData = kanjiData.filter(item => {
                    // Check kanji, romaji_basic directly
                    if (item.kanji && item.kanji.includes(keyword)) return true;
                    if (item.romaji_basic && item.romaji_basic.toLowerCase().includes(keyword)) return true;

                    // Check readings
                    if (item.readings) {
                        if (item.readings.kunyomi && item.readings.kunyomi.some(r =>
                            (r.reading && r.reading.toLowerCase().includes(keyword)) || (r.romaji && r.romaji.toLowerCase().includes(keyword))
                        )) return true;
                        if (item.readings.onyomi && item.readings.onyomi.some(r =>
                            (r.reading && r.reading.toLowerCase().includes(keyword)) || (r.romaji && r.romaji.toLowerCase().includes(keyword)) ||
                            (r.example && ((r.example.word && r.example.word.toLowerCase().includes(keyword)) || (r.example.romaji && r.example.romaji.toLowerCase().includes(keyword)) || (r.example.meaning && r.example.meaning.toLowerCase().includes(keyword))))
                        )) return true;
                    }

                    // Check meanings
                    if (item.meanings && item.meanings.some(m =>
                        (m.meaning && m.meaning.toLowerCase().includes(keyword)) || (m.form && m.form.toLowerCase().includes(keyword)) || (m.romaji && m.romaji.toLowerCase().includes(keyword))
                    )) return true;

                    // Check examples
                    if (item.examples && item.examples.some(e =>
                        (e.japanese && e.japanese.includes(keyword)) || (e.furigana && e.furigana.includes(keyword)) || (e.romaji && e.romaji.toLowerCase().includes(keyword)) || (e.meaning && e.meaning.toLowerCase().includes(keyword))
                    )) return true;

                    // Check metadata (optional, based on search relevance)
                    if (item.metadata) {
                         if (item.metadata.jlpt_level && item.metadata.jlpt_level.toLowerCase().includes(keyword)) return true;
                        // Add checks for frequency/stroke count if needed, requires parsing keyword as number
                        // Example for frequency rank (searching for the exact number):
                        // if (!isNaN(parseInt(keyword)) && item.metadata.frequency_rank === parseInt(keyword)) return true;
                    }

                    return false; // No match
                });
            }

            currentPage = 1;
            renderKanji();
            updateStatus();
        }

        // Render Kanji Cards
        function renderKanji() {
            kanjiContainer.innerHTML = ''; // Clear current grid

            if (filteredData.length === 0) {
                kanjiContainer.innerHTML = `
                    <div class="message">
                        Tidak ditemukan kanji yang cocok${searchInput.value ? ` untuk pencarian "${searchInput.value}"` : ''}.
                    </div>
                `;
                return;
            }

            // Pagination logic
            let dataToRender;
            if (perPage === 0) { // Show All
                dataToRender = filteredData;
            } else {
                const start = (currentPage - 1) * perPage;
                const end = start + perPage;
                dataToRender = filteredData.slice(start, end);
            }

            dataToRender.forEach((item, index) => {
                 const card = document.createElement('div');
                 card.classList.add('kanji-card');
                 // Use a data attribute to store the kanji character for easier lookup if needed, though passing the object directly is better here
                 card.dataset.kanji = item.kanji;
                 card.innerHTML = `
                    <div class="kanji">${item.kanji || '?'}</div>
                    ${item.romaji_basic ? `<div class="romaji-basic">${item.romaji_basic}</div>` : ''}
                 `;
                 // Add click listener to open flashcard
                 card.addEventListener('click', () => openFlashcard(item));
                 kanjiContainer.appendChild(card);
            });
        }

        // Open Flashcard Modal
        function openFlashcard(data) {
            activeKanjiData = data; // Store data for potential future use (if needed)
            console.log("Opening flashcard with data:", data); // Log data for debugging

            // Populate flashcard content
            let contentHTML = ''; // Start with empty string

            // --- Kanji and Basic Romaji ---
            contentHTML += `<h2>${data.kanji || 'Kanji tidak tersedia'}</h2>`;
            if (data.romaji_basic) {
                contentHTML += `<div class="romaji-basic-modal">${data.romaji_basic}</div>`;
            } else {
                 contentHTML += `<div class="romaji-basic-modal">Romaji dasar tidak tersedia</div>`;
            }


            // --- Readings (Kunyomi & Onyomi) ---
            contentHTML += `<h3>Bacaan</h3>`;
            let hasAnyReadingData = false; // Flag to check if any readings data structure exists

            if (data.readings) {
                hasAnyReadingData = true; // The readings object exists

                if (data.readings.kunyomi && data.readings.kunyomi.length > 0) {
                    contentHTML += `<h4>Kunyomi:</h4><ul>`;
                    data.readings.kunyomi.forEach(r => {
                         contentHTML += `<li class="reading-item">
                                <span><span class="reading">${r.reading || 'Tidak tersedia'}</span> <span class="romaji">(${r.romaji || 'Tidak tersedia'})</span></span>
                             </li>`;
                    });
                    contentHTML += `</ul>`;
                } else {
                     contentHTML += `<p>Tidak ada data Kunyomi.</p>`;
                }

                 if (data.readings.onyomi && data.readings.onyomi.length > 0) {
                     contentHTML += `<h4>Onyomi:</h4><ul>`;
                     data.readings.onyomi.forEach(r => {
                         contentHTML += `<li class="reading-item">
                                <span><span class="reading">${r.reading || 'Tidak tersedia'}</span> <span class="romaji">(${r.romaji || 'Tidak tersedia'})</span></span>
                                ${r.example ?
                                    `<span class="example-word">Contoh: ${r.example.word || 'Tidak tersedia'} <span class="romaji">(${r.example.romaji || 'Tidak tersedia'})</span> - ${r.example.meaning || 'Tidak tersedia'}</span>` :
                                    ''
                                }
                             </li>`;
                    });
                    contentHTML += `</ul>`;
                } else {
                     contentHTML += `<p>Tidak ada data Onyomi.</p>`;
                }

            }

            // If the readings object was missing entirely, or both arrays were empty after checking
            if (!hasAnyReadingData || ((!data.readings || !data.readings.kunyomi || data.readings.kunyomi.length === 0) && (!data.readings || !data.readings.onyomi || data.readings.onyomi.length === 0))) {
                 if(hasAnyReadingData) { // If readings object existed but both arrays were empty
                      // Message already added by the individual checks
                 } else { // If readings object didn't exist at all
                     contentHTML += `<p>Data bacaan tidak tersedia.</p>`;
                 }
            }


             // --- Meanings (Verb/Adjective forms) ---
            contentHTML += `<h3>Makna (Bentuk Kata Kerja/Sifat)</h3>`;
            if (data.meanings && data.meanings.length > 0) {
                contentHTML += `<ul>`;
                data.meanings.forEach(m => {
                    contentHTML += `<li class="meaning-item">
                         <span><span class="meaning-form">${m.form || 'Tidak tersedia'}</span> <span class="romaji">(${m.romaji || 'Tidak tersedia'})</span></span>
                         <span class="meaning-text">${m.meaning || 'Tidak tersedia'}</span>
                    </li>`;
                });
                contentHTML += `</ul>`;
            } else {
                 contentHTML += `<p>Data makna tidak tersedia.</p>`;
            }


            // --- Examples (Sentences) ---
            contentHTML += `<h3>Contoh Kalimat</h3>`;
            if (data.examples && data.examples.length > 0) {
                contentHTML += `<ul>`;
                data.examples.forEach(e => {
                    // Using <ruby> for furigana if available
                    const japaneseWithFurigana = (e.japanese && e.furigana) ?
                        `<ruby>${e.japanese}<rt>${e.furigana}</rt></ruby>` :
                        e.japanese || 'Tidak tersedia'; // Fallback if japanese or furigana missing

                    contentHTML += `<li class="example-item">
                         <span class="example-japanese">${japaneseWithFurigana}</span>
                         <span class="example-romaji">${e.romaji || 'Tidak tersedia'}</span>
                         <span class="example-meaning">${e.meaning || 'Tidak tersedia'}</span>
                    </li>`;
                });
                contentHTML += `</ul>`;
            } else {
                 contentHTML += `<p>Data contoh kalimat tidak tersedia.</p>`;
            }

            // --- Metadata ---
            contentHTML += `<h3>Metadata</h3>`;
            if (data.metadata) {
                let hasMetadata = false;
                 let metadataHTML = `<div class="metadata">`;
                if (data.metadata.jlpt_level) { metadataHTML += `<span>Level JLPT: ${data.metadata.jlpt_level}</span>`; hasMetadata = true; }
                 if (data.metadata.frequency_rank) { metadataHTML += `<span>Rangking Frekuensi: ${data.metadata.frequency_rank}</span>`; hasMetadata = true; }
                if (data.metadata.stroke_count) { metadataHTML += `<span>Jumlah Goresan: ${data.metadata.stroke_count}</span>`; hasMetadata = true; }

                 if (hasMetadata) {
                     contentHTML += metadataHTML + `</div>`; // Add metadata div if any data was found
                 } else {
                      contentHTML += `<p>Tidak ada data metadata.</p>`; // Message if metadata object exists but is empty
                 }

            } else {
                 contentHTML += `<p>Data metadata tidak tersedia.</p>`; // Message if metadata object doesn't exist
            }


            flashcardContent.innerHTML = contentHTML; // Set the generated content

            // Show modal with slight delay to allow content to be rendered before animation
            flashcardModalOverlay.classList.add('visible');
            // The CSS transition on .flashcard handles the rotation and opacity fade-in
        }

        // Close Flashcard Modal
        function closeFlashcard() {
            // Add a class to trigger reverse animation (optional, but good)
            // flashcardContent.classList.remove('flipped'); // If using front/back flip

            // Hide modal after animation completes (matching the transition duration)
            setTimeout(() => {
                flashcardModalOverlay.classList.remove('visible');
                // Decide if you want to clear content here or keep it until next open
                // Keeping it can sometimes flash old data, clearing is safer.
                // flashcardContent.innerHTML = ''; // Clear content when hidden
                activeKanjiData = null; // Clear active data
            }, 300); // Match this timeout to the CSS transition duration of modal-overlay opacity
        }


        // Update Status
        function updateStatus() {
            const totalItems = filteredData.length;
            let statusText = '';

            // Hide pagination controls if showing all or no data
            const paginationControls = document.querySelector('.pagination-controls');
             if (perPage === 0 || totalItems <= perPage && totalItems > 0) {
                 paginationControls.style.visibility = 'hidden';
             } else {
                 paginationControls.style.visibility = 'visible';
             }


            if (totalItems === 0) {
                 statusText = `Tidak ada kanji ditemukan di level ${currentLevel.toUpperCase()}.`;
                 if(searchInput.value) statusText += ` (untuk pencarian "${searchInput.value}")`;
                 pageInfo.textContent = `Halaman 0/0`;
                 prevBtn.disabled = true;
                 nextBtn.disabled = true;

            } else if (perPage === 0) { // Show All
                statusText = `Menampilkan semua ${totalItems} kanji ${currentLevel.toUpperCase()}`;
                 if(searchInput.value) statusText += ` (hasil pencarian "${searchInput.value}")`;
                 pageInfo.textContent = `Halaman 1/1`; // Still show 1/1
                 prevBtn.disabled = true;
                 nextBtn.disabled = true;

            } else {
                const totalPages = Math.ceil(totalItems / perPage);
                // Handle case where filter results are less than perPage, leading to 0 pages if totalItems is 0
                 if (totalPages === 0) { // This happens if totalItems > 0 but < perPage, although totalItems === 0 is handled above
                     statusText = `Menampilkan 0 dari ${totalItems} kanji ${currentLevel.toUpperCase()}`; // Should not happen if totalItems > 0
                     pageInfo.textContent = `Halaman 0/0`;
                     prevBtn.disabled = true;
                     nextBtn.disabled = true;
                 } else {
                     const start = (currentPage - 1) * perPage + 1;
                     const end = Math.min(currentPage * perPage, totalItems);
                     statusText = `Menampilkan ${start}-${end} dari ${totalItems} kanji ${currentLevel.toUpperCase()}`;
                     pageInfo.textContent = `Halaman ${currentPage}/${totalPages}`;
                     prevBtn.disabled = currentPage === 1;
                     nextBtn.disabled = currentPage === totalPages;
                 }
                 if(searchInput.value) statusText += ` (hasil pencarian "${searchInput.value}")`;
            }

            statusInfo.textContent = statusText;
        }

         // Scroll to top of the window/document on page change
         function scrollToTop() {
             window.scrollTo({
                 top: 0,
                 behavior: 'smooth'
             });
         }


        // Debounce Function
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // Theme Functions
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.querySelector('.theme-toggle i');

            if (theme === 'dark') {
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                icon.classList.replace('fa-sun', 'fa-moon');
            }
        }
    </script>
</body>
</html>
